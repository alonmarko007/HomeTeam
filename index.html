<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>××¨×§×•×‘×™×¥' v31.23 - Final Performance Build</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { --p: #4a90e2; --success: #2ed573; --danger: #ff4757; --gold: #f1c40f; --bg: #f4f7f6; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); margin: 0; direction: rtl; user-select: none; color: #333; overflow-x: hidden; }
        
        .app { max-width: 500px; margin: 0 auto; min-height: 100vh; background: white; display: flex; flex-direction: column; box-shadow: 0 0 30px rgba(0,0,0,0.05); }
        .hidden { display: none !important; }
        
        /* Fast UI Components */
        .card-item { background: #fff; border: 1.5px solid #eaeaea; border-radius: 20px; padding: 15px; margin-bottom: 12px; display: flex; align-items: center; cursor: pointer; transition: transform 0.1s; }
        .card-item:active { transform: scale(0.98); background: #fcfcfc; }
        
        .score-box { background: linear-gradient(135deg, var(--p), #67a6ed); color: white; border-radius: 25px; padding: 20px; margin: 20px; text-align: center; box-shadow: 0 10px 20px rgba(74,144,226,0.3); }
        .score-val { font-size: 3.5rem; font-weight: 900; display: block; line-height: 1; }
        
        /* Goal Bar */
        .goal-container { background: #fff; margin: 0 20px 20px; padding: 15px; border-radius: 20px; border: 1px solid #eee; }
        .progress-bg { background: #eee; height: 14px; border-radius: 10px; margin-top: 10px; overflow: hidden; }
        .progress-fill { background: var(--success); height: 100%; width: 0%; transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); }

        /* Navigation & Buttons */
        .admin-nav { display: flex; gap: 5px; padding: 10px; background: #f8f9fa; }
        .nav-btn { flex: 1; border: none; padding: 12px; border-radius: 12px; font-weight: bold; background: #eee; cursor: pointer; }
        .nav-btn.active { background: var(--p); color: white; }

        .btn-action { width: 100%; border: none; padding: 16px; border-radius: 16px; font-weight: 800; font-size: 1.1rem; cursor: pointer; transition: 0.2s; }
        
        .avatar { width: 70px; height: 70px; border-radius: 50%; background: #eef2f3; border: 3px solid var(--p); display: flex; align-items: center; justify-content: center; font-size: 1.8rem; margin: 0 auto 8px; }
        
        input, select { width: 100%; padding: 14px; margin-bottom: 10px; border: 1.5px solid #ddd; border-radius: 12px; font-size: 1rem; }
        .version { font-size: 0.7rem; color: #bbb; padding: 10px; text-align: center; margin-top: auto; }
    </style>
</head>
<body>

<div class="app">
    <div id="view-lobby">
        <h1 style="text-align:center; margin-top:30px;">×”×‘×™×ª ×©×œ ××¨×§×•×‘×™×¥'</h1>
        <div class="goal-container">
            <div id="goal-title" style="font-weight:bold; font-size:0.9rem;">×˜×•×¢×Ÿ ×™×¢×“...</div>
            <div class="progress-bg"><div id="goal-bar" class="progress-fill"></div></div>
            <div id="goal-stats" style="text-align:left; font-size:0.8rem; margin-top:4px; font-weight:bold;">0 / 0</div>
        </div>
        <div id="kids-grid" style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:15px; padding:20px;"></div>
        <div style="padding:20px; text-align:center;">
            <button onclick="authAdmin()" style="background:none; border:none; color:#ccc; font-weight:bold;">âš™ï¸ ×›× ×™×¡×ª ×”×•×¨×™×</button>
        </div>
    </div>

    <div id="view-child" class="hidden">
        <div class="score-box">
            <span id="child-points" class="score-val">0</span>
            <span style="font-weight:bold; opacity:0.9;">×›×•×›×‘×™× ×©×¦×‘×¨×ª</span>
        </div>
        
        <div id="child-tasks-screen" class="padding:0 20px;">
            <div id="tasks-render-area" style="padding:0 20px;"></div>
            <div style="padding:20px;">
                <button onclick="openStore()" class="btn-action" style="background:var(--gold); color:white; box-shadow: 0 6px 15px rgba(241,196,15,0.3);">ğŸ ×—× ×•×ª ×¤×¨×¡×™×</button>
            </div>
        </div>

        <div id="child-store-screen" class="hidden" style="padding:0 20px;">
            <h2 style="text-align:center; color:var(--gold);">×—× ×•×ª ×”×¤×¨×¡×™× ğŸ›ï¸</h2>
            <div id="store-render-area"></div>
            <button onclick="closeStore()" style="width:100%; background:#eee; border:none; padding:15px; border-radius:15px; margin-top:10px;">×—×–×¨×” ×œ××©×™××•×ª</button>
        </div>
        <button onclick="location.reload()" style="margin:20px; background:none; border:none; color:#bbb; width:calc(100% - 40px);">ğŸ  ×”×—×œ×£ ××©×ª××©</button>
    </div>

    <div id="view-admin" class="hidden">
        <div class="admin-nav">
            <button id="tab-btn-approve" class="nav-btn active" onclick="setTab('approve')">××™×©×•×¨×™×</button>
            <button id="tab-btn-tasks" class="nav-btn" onclick="setTab('tasks')">××©×™××•×ª</button>
            <button id="tab-btn-settings" class="nav-btn" onclick="setTab('settings')">×”×’×“×¨×•×ª</button>
        </div>
        <div id="admin-main-area" style="padding:20px; flex-grow:1; overflow-y:auto;"></div>
        <button onclick="location.reload()" style="margin:20px; padding:12px; background:#333; color:white; border-radius:12px; border:none;">ğŸ  ×—×–×¨×” ×œ×‘×™×ª</button>
    </div>

    <div class="version">v31.23 | SECURE DATA | HIGH SPEED</div>
</div>

<script>
    // ×”× ×“×¡×ª × ×ª×•× ×™× - ××¤×ª×— ×§×‘×•×¢
    const DB_KEY = 'MARKOVICH_FINAL_DB';
    
    const INITIAL_DB = {
        children: [
            {id: 1, name: "×¨× ×™", pin: "1234", points: 0, done: []},
            {id: 2, name: "××•×¤×™×¨", pin: "1234", points: 0, done: []},
            {id: 3, name: "××•×¨×™", pin: "1234", points: 0, done: []}
        ],
        tasks: [
            {id: 101, name: "×¦×—×¦×•×— ×©×™× ×™×™×", points: 2, type: "both", emoji: "ğŸ¦·"},
            {id: 102, name: "×œ×”×ª×œ×‘×© ×œ×‘×“", points: 2, type: "morning", emoji: "ğŸ‘•"}
        ],
        rewards: [
            {id: 201, name: "×–××Ÿ ××¡×š", points: 10, emoji: "ğŸ“±"},
            {id: 202, name: "×××ª×§ ×œ×‘×—×™×¨×”", points: 5, emoji: "ğŸ­"}
        ],
        pending: [],
        goal: { name: "×¢×¨×‘ ×¤×™×¦×”", target: 100, current: 0 }
    };

    // ×× ×’× ×•×Ÿ Deep Merge ×œ×˜×¢×™× ×ª ×“××˜×”
    let state = (() => {
        const saved = localStorage.getItem(DB_KEY);
        if (!saved) return INITIAL_DB;
        const parsed = JSON.parse(saved);
        // ×•×™×“×•× ×©×›×œ ×”××¢×¨×›×™× ×§×™×™××™× (×”×’× ×” ××¤× ×™ ×§×•×“ ×™×©×Ÿ)
        return { ...INITIAL_DB, ...parsed, 
            children: parsed.children || INITIAL_DB.children,
            tasks: parsed.tasks || INITIAL_DB.tasks,
            rewards: parsed.rewards || INITIAL_DB.rewards,
            pending: parsed.pending || INITIAL_DB.pending
        };
    })();

    let activeKidIdx = -1;
    let activeTab = 'approve';

    function sync() {
        localStorage.setItem(DB_KEY, JSON.stringify(state));
        renderLobby();
    }

    // --- ×”×•×¨×” ---
    function setTab(t) {
        activeTab = t;
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.toggle('active', b.id.includes(t)));
        renderAdmin();
    }

    function renderAdmin() {
        const area = document.getElementById('admin-main-area');
        if (activeTab === 'approve') {
            area.innerHTML = state.pending.map((p, i) => `
                <div class="card-item" style="justify-content:space-between">
                    <div style="text-align:right"><b>${p.childName}</b><br>${p.taskName} (+${p.pts})</div>
                    <div style="display:flex; gap:5px;">
                        <button onclick="approve(${i})" style="background:var(--success); color:white; border:none; padding:10px; border-radius:10px;">âœ…</button>
                        <button onclick="state.pending.splice(${i},1);sync();renderAdmin();" style="background:var(--danger); color:white; border:none; padding:10px; border-radius:10px;">âŒ</button>
                    </div>
                </div>`).join('') || "××™×Ÿ ×‘×§×©×•×ª ×××ª×™× ×•×ª";
        } else if (activeTab === 'tasks') {
            area.innerHTML = `
                <div style="background:#f9f9f9; padding:15px; border-radius:15px; margin-bottom:20px;">
                    <input type="text" id="new-t-name" placeholder="×©× ×”××©×™××”">
                    <input type="number" id="new-t-pts" placeholder="×›×•×›×‘×™×">
                    <button onclick="addNewTask()" class="btn-action" style="background:var(--p); color:white;">+ ×”×•×¡×£ ××©×™××”</button>
                </div>
                ` + state.tasks.map((t, i) => `
                <div class="card-item">
                    <div style="flex-grow:1; text-align:right;">${t.emoji} ${t.name} (${t.points})</div>
                    <button onclick="state.tasks.splice(${i},1);sync();renderAdmin();" style="background:none; border:none; color:red;">ğŸ—‘ï¸</button>
                </div>`).join('');
        } else if (activeTab === 'settings') {
            area.innerHTML = `
                <h3>×”×’×“×¨×ª ×™×¢×“ ××©×¤×—×ª×™</h3>
                <input type="text" id="goal-name" value="${state.goal.name}">
                <input type="number" id="goal-target" value="${state.goal.target}">
                <button onclick="updateGoal()" class="btn-action" style="background:var(--success); color:white;">×¢×“×›×Ÿ ×™×¢×“</button>
                <hr style="margin:20px 0; opacity:0.2;">
                <button onclick="if(confirm('×œ××—×•×§ ×”×›×œ?')) {localStorage.clear(); location.reload();}" style="color:red; background:none; border:none;">âš ï¸ ××¤×¡ ××ª ×›×œ ×”××¤×œ×™×§×¦×™×”</button>
            `;
        }
    }

    function approve(idx) {
        const p = state.pending[idx];
        const kid = state.children.find(c => c.name === p.childName);
        if (kid) {
            kid.points += p.pts;
            state.goal.current += p.pts;
            if (!kid.done) kid.done = [];
            kid.done.push({id: p.taskId, d: new Date().toLocaleDateString(), s: p.sess});
        }
        state.pending.splice(idx, 1);
        confetti();
        sync();
        renderAdmin();
    }

    function addNewTask() {
        const n = document.getElementById('new-t-name').value;
        const p = parseInt(document.getElementById('new-t-pts').value);
        if (n && p) {
            state.tasks.push({id: Date.now(), name: n, points: p, type: 'both', emoji: 'âœ¨'});
            sync(); renderAdmin();
        }
    }

    function updateGoal() {
        state.goal.name = document.getElementById('goal-name').value;
        state.goal.target = parseInt(document.getElementById('goal-target').value);
        sync(); alert("×¢×•×“×›×Ÿ!");
    }

    // --- ×™×œ×“ ---
    function renderChild() {
        const kid = state.children[activeKidIdx];
        const hr = new Date().getHours();
        const sess = hr < 15 ? 'am' : 'pm';
        const today = new Date().toLocaleDateString();

        document.getElementById('child-points').innerText = kid.points;
        
        const available = state.tasks.filter(t => {
            const isDone = kid.done && kid.done.some(d => d.id === t.id && d.d === today && d.s === sess);
            const isPending = state.pending.some(p => p.childName === kid.name && p.taskId === t.id && p.sess === sess);
            if (isDone || isPending) return false;
            if (t.type === 'morning') return hr < 15;
            if (t.type === 'evening') return hr >= 12;
            return true;
        });

        document.getElementById('tasks-render-area').innerHTML = available.map(t => `
            <div class="card-item" onclick="reqTask(${t.id}, '${t.name}', ${t.points})">
                <div style="font-size:1.5rem; margin-left:15px;">${t.emoji}</div>
                <div style="flex-grow:1; text-align:right; font-weight:bold;">${t.name}</div>
                <div style="color:var(--p); font-weight:900;">+${t.points} â­</div>
            </div>`).join('') || "<div style='text-align:center; padding:20px; color:#aaa;'>××™×Ÿ ××©×™××•×ª ×›×¨×’×¢, ×›×œ ×”×›×‘×•×“! ğŸ†</div>";
    }

    function reqTask(id, name, pts) {
        const sess = new Date().getHours() < 15 ? 'am' : 'pm';
        state.pending.push({ taskId: id, taskName: name, childName: state.children[activeKidIdx].name, pts: pts, sess: sess });
        sync(); renderChild();
        alert("× ×©×œ×— ×œ××™×©×•×¨ ×”×•×¨×™×! âœ…");
    }

    function openStore() {
        document.getElementById('child-tasks-screen').classList.add('hidden');
        document.getElementById('child-store-screen').classList.remove('hidden');
        document.getElementById('store-render-area').innerHTML = state.rewards.map(r => `
            <div class="card-item" onclick="buyReward('${r.name}', ${r.points})">
                <div style="font-size:1.5rem; margin-left:15px;">${r.emoji}</div>
                <div style="flex-grow:1; text-align:right; font-weight:bold;">${r.name}</div>
                <div style="color:var(--gold); font-weight:900;">${r.points} â­</div>
            </div>`).join('');
    }

    function buyReward(name, cost) {
        const kid = state.children[activeKidIdx];
        if (kid.points < cost) return alert("×—×¡×¨×™× ×œ×š ×›×•×›×‘×™×! ×ª××©×™×š ×‘××©×™××•×ª ğŸ’ª");
        if (confirm(`×œ×§× ×•×ª ${name} ×‘-${cost} ×›×•×›×‘×™×?`)) {
            kid.points -= cost;
            sync(); closeStore(); renderChild();
            alert("×ª×ª×—×“×©! ×‘×§×© ××”×”×•×¨×™× ××ª ×”×¤×¨×¡ ğŸ");
        }
    }

    function closeStore() {
        document.getElementById('child-tasks-screen').classList.remove('hidden');
        document.getElementById('child-store-screen').classList.add('hidden');
    }

    // --- ×›× ×™×¡×” ---
    function authAdmin() { if (prompt("×¡×™×¡××”:") === "1234") { document.getElementById('view-lobby').classList.add('hidden'); document.getElementById('view-admin').classList.remove('hidden'); setTab('approve'); } }
    
    function login(idx) {
        if (prompt("×¡×™×¡××”:") === state.children[idx].pin) {
            activeKidIdx = idx;
            document.getElementById('view-lobby').classList.add('hidden');
            document.getElementById('view-child').classList.remove('hidden');
            renderChild();
        }
    }

    function renderLobby() {
        document.getElementById('kids-grid').innerHTML = state.children.map((c, i) => `
            <div onclick="login(${i})" style="text-align:center; cursor:pointer;">
                <div class="avatar">ğŸ‘¤</div>
                <div style="font-weight:bold; font-size:0.9rem;">${c.name}</div>
                <div style="font-size:0.8rem; color:var(--p); font-weight:bold;">${c.points} â­</div>
            </div>`).join('');
        
        const prc = Math.min((state.goal.current / state.goal.target) * 100, 100);
        document.getElementById('goal-bar').style.width = prc + "%";
        document.getElementById('goal-title').innerText = `×”×™×¢×“ ×©×œ× ×•: ${state.goal.name}`;
        document.getElementById('goal-stats').innerText = `${state.goal.current} / ${state.goal.target}`;
    }

    // ×”×¤×¢×œ×” ×¨××©×•× ×™×ª
    renderLobby();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>××¨×§×•×‘×™×¥' v31.25 - Parent Preview</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { --p: #4a90e2; --success: #2ed573; --danger: #ff4757; --gold: #f1c40f; --bg: #f4f7f6; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); margin: 0; direction: rtl; user-select: none; color: #333; }
        .app { max-width: 500px; margin: 0 auto; min-height: 100vh; background: white; display: flex; flex-direction: column; box-shadow: 0 0 30px rgba(0,0,0,0.1); position: relative; }
        .hidden { display: none !important; }
        
        /* Preview Banner */
        .preview-banner { background: #2d3436; color: white; padding: 10px; text-align: center; font-size: 0.8rem; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }

        /* Goal Component */
        .goal-card { background: #fff9e6; margin: 20px; padding: 20px; border-radius: 25px; border: 2px solid #fcebb6; }
        .progress-container { background: #eee; height: 20px; border-radius: 10px; margin: 12px 0; overflow: hidden; position: relative; }
        .progress-fill { background: linear-gradient(90deg, #2ed573, #7bed9f); height: 100%; width: 0%; transition: width 1s ease; }
        .progress-text { position: absolute; width: 100%; text-align: center; font-size: 0.8rem; font-weight: bold; line-height: 20px; top: 0; }

        /* Items */
        .item-row { background: white; border: 1px solid #eee; border-radius: 20px; padding: 15px; margin-bottom: 12px; display: flex; align-items: center; cursor: pointer; }
        .item-icon { width: 50px; height: 50px; background: #f0f7ff; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; margin-left: 15px; }
        .item-info { flex-grow: 1; text-align: right; }
        .pts-tag { background: #fff4e5; color: #e67e22; padding: 5px 12px; border-radius: 12px; font-weight: 800; font-size: 0.9rem; }

        /* Child Score */
        .score-header { padding: 30px 20px; text-align: center; }
        .big-score { font-size: 4rem; font-weight: 900; color: var(--p); line-height: 1; display: block; }

        /* Navigation */
        .admin-nav { display: flex; background: #f1f2f6; margin: 10px; border-radius: 15px; padding: 5px; overflow-x: auto; }
        .nav-tab { flex: 1; border: none; padding: 10px; border-radius: 10px; font-weight: bold; background: none; cursor: pointer; font-size: 0.85rem; min-width: 70px; }
        .nav-tab.active { background: white; color: var(--p); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

        .btn-gold { background: var(--gold); color: white; border: none; padding: 18px; border-radius: 20px; font-weight: 800; width: 100%; }
        .btn-view { background: #f1f2f6; border: none; padding: 8px; border-radius: 8px; cursor: pointer; font-size: 0.75rem; font-weight: bold; }
        
        .avatar-circle { width: 70px; height: 70px; border-radius: 50%; border: 3px solid var(--p); display: flex; align-items: center; justify-content: center; font-size: 1.8rem; background: white; margin: 0 auto 5px; }
        .version-label { font-size: 0.7rem; color: #ccc; text-align: center; padding: 15px; font-weight: bold; }
    </style>
</head>
<body>

<div class="app">
    <div id="banner-preview" class="preview-banner hidden">
        <span>ğŸ‘ï¸ ××¦×‘ ×¦×¤×™×™×” ×©×œ ×”×•×¨×”</span>
        <button onclick="exitPreview()" style="background:var(--danger); color:white; border:none; padding:4px 10px; border-radius:5px; cursor:pointer;">×—×–×¨×” ×œ× ×™×”×•×œ</button>
    </div>

    <div id="screen-lobby">
        <h1 style="text-align:center; margin-top:20px;">××¨×§×•×‘×™×¥' âœ¨</h1>
        <div class="goal-card">
            <div id="lobby-goal-name" style="font-weight:bold; color:#d35400;">×”×™×¢×“ ×”××©×¤×—×ª×™: ×˜×•×¢×Ÿ...</div>
            <div class="progress-container">
                <div id="lobby-goal-bar" class="progress-fill"></div>
                <div id="lobby-goal-stats" class="progress-text">0 / 0</div>
            </div>
        </div>
        <div id="lobby-kids" style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; padding:15px;"></div>
        <button onclick="enterAdmin()" style="background:none; border:none; color:#ccc; width:100%; font-weight:bold; margin-top:10px;">âš™ï¸ × ×™×”×•×œ ×”×•×¨×™×</button>
        <div class="version-label">v31.25 | PREVIEW MODE ENABLED</div>
    </div>

    <div id="screen-child" class="hidden">
        <div class="score-header">
            <h2 id="child-title" style="margin:0;"></h2>
            <span id="child-score" class="big-score">0</span>
            <span style="font-weight:bold; color:#666;">×›×•×›×‘×™× ×©×¦×‘×¨×ª</span>
        </div>
        <div id="child-tasks-panel" style="padding:0 20px;">
            <div id="child-tasks-list"></div>
            <button onclick="openStore()" class="btn-gold" style="margin-top:20px;">ğŸ ×—× ×•×ª ×”×¦'×•×¤×¨×™×</button>
        </div>
        <div id="child-store-panel" class="hidden" style="padding:0 20px;">
            <h2 style="text-align:center; color:var(--gold);">×—× ×•×ª ×”×¦'×•×¤×¨×™×</h2>
            <div id="child-rewards-list"></div>
            <button onclick="closeStore()" style="width:100%; background:#eee; border:none; padding:15px; border-radius:15px; margin-top:10px;">ğŸ”™ ×—×–×¨×” ×œ××©×™××•×ª</button>
        </div>
        <button id="btn-logout" onclick="location.reload()" style="margin:20px auto; display:block; background:none; border:none; color:#bbb;">ğŸ  ×”×—×œ×£ ×™×œ×“</button>
    </div>

    <div id="screen-admin" class="hidden">
        <div class="admin-nav">
            <button id="tab-approve" class="nav-tab active" onclick="setAdminTab('approve')">××™×©×•×¨×™×</button>
            <button id="tab-tasks" class="nav-tab" onclick="setAdminTab('tasks')">××©×™××•×ª</button>
            <button id="tab-kids" class="nav-tab" onclick="setAdminTab('kids')">×™×œ×“×™×</button>
            <button id="tab-config" class="nav-tab" onclick="setAdminTab('config')">×”×’×“×¨×•×ª</button>
        </div>
        <div id="admin-main" style="padding:15px; flex-grow:1; overflow-y:auto;"></div>
        <button onclick="location.reload()" style="margin:15px; background:#333; color:white; border:none; padding:12px; border-radius:10px;">ğŸ  ×—×–×¨×” ×œ×‘×™×ª</button>
    </div>
</div>

<script>
    const STORAGE_KEY = 'MARKOVICH_FINAL_DB';
    const DEFAULTS = {
        children: [{id:1, name:"×¨× ×™", pin:"1234", points:0, done:[]}, {id:2, name:"××•×¤×™×¨", pin:"1234", points:0, done:[]}, {id:3, name:"××•×¨×™", pin:"1234", points:0, done:[]}],
        tasks: [{id:101, name:"×¦×—×¦×•×— ×©×™× ×™×™×", points:2, type:"both", emoji:"ğŸ¦·"}, {id:102, name:"×œ×”×ª×œ×‘×© ×œ×‘×“", points:2, type:"morning", emoji:"ğŸ‘•"}],
        rewards: [{id:201, name:"×–××Ÿ ××¡×š", points:10, emoji:"ğŸ“±"}, {id:202, name:"×××ª×§", points:5, emoji:"ğŸ­"}],
        pending: [], goal: { name: "×¢×¨×‘ ×¤×™×¦×”", target: 100, current: 0 }
    };

    let db = JSON.parse(localStorage.getItem(STORAGE_KEY)) || DEFAULTS;
    db = {...DEFAULTS, ...db}; 
    let activeKidIdx = -1;
    let activeTab = 'approve';
    let isPreviewMode = false;

    function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); renderLobby(); }

    // --- Admin ---
    function setAdminTab(t) {
        activeTab = t;
        document.querySelectorAll('.nav-tab').forEach(btn => btn.classList.toggle('active', btn.id.includes(t)));
        renderAdmin();
    }

    function renderAdmin() {
        const main = document.getElementById('admin-main');
        if (activeTab === 'approve') {
            main.innerHTML = db.pending.map((p, i) => `
                <div class="item-row" style="justify-content:space-between">
                    <div style="text-align:right"><b>${p.childName}</b><br>${p.taskName} (+${p.pts}â­)</div>
                    <div>
                        <button onclick="approve(${i})" style="background:var(--success); color:white; border:none; padding:10px; border-radius:10px;">âœ…</button>
                    </div>
                </div>`).join('') || "××™×Ÿ ×‘×§×©×•×ª";
        } else if (activeTab === 'kids') {
            main.innerHTML = db.children.map((c, i) => `
                <div class="item-row" style="justify-content:space-between">
                    <div style="text-align:right"><b>${c.name}</b> (${c.points} â­)</div>
                    <button class="btn-view" onclick="enterPreview(${i})">ğŸ‘ï¸ ×¦×¤×™×™×” ×›×™×œ×“</button>
                </div>`).join('');
        } else if (activeTab === 'tasks') {
            main.innerHTML = `<button class="btn-gold" style="font-size:0.9rem; padding:10px; margin-bottom:15px;" onclick="addTask()">+ ××©×™××” ×—×“×©×”</button>` + 
                db.tasks.map((t, i) => `<div class="item-row"><div style="flex-grow:1; text-align:right;">${t.emoji} ${t.name}</div><button onclick="db.tasks.splice(${i},1);save();renderAdmin();" style="border:none; background:none;">ğŸ—‘ï¸</button></div>`).join('');
        } else if (activeTab === 'config') {
            main.innerHTML = `<h3>×”×™×¢×“ ×”××©×¤×—×ª×™</h3><input type="text" id="g-n" value="${db.goal.name}" style="width:100%; padding:10px; margin-bottom:10px;"><input type="number" id="g-t" value="${db.goal.target}" style="width:100%; padding:10px;"><button onclick="db.goal.name=document.getElementById('g-n').value;db.goal.target=parseInt(document.getElementById('g-t').value);save();alert('×¢×•×“×›×Ÿ');" class="btn-gold" style="margin-top:10px; padding:10px;">×¢×“×›×Ÿ</button>`;
        }
    }

    function approve(idx) {
        const p = db.pending[idx];
        const kid = db.children.find(c => c.name === p.childName);
        if(kid) { kid.points += p.pts; db.goal.current += p.pts; if(!kid.done) kid.done = []; kid.done.push({id: p.taskId, d: new Date().toLocaleDateString(), s: p.sess}); }
        db.pending.splice(idx, 1); confetti(); save(); renderAdmin();
    }

    function addTask() { const n = prompt("×©× ×”××©×™××”:"); if(n) { db.tasks.push({id:Date.now(), name:n, points:2, type:'both', emoji:'âœ¨'}); save(); renderAdmin(); } }

    // --- Preview Logic ---
    function enterPreview(idx) {
        isPreviewMode = true;
        activeKidIdx = idx;
        document.getElementById('screen-admin').classList.add('hidden');
        document.getElementById('screen-child').classList.remove('hidden');
        document.getElementById('banner-preview').classList.remove('hidden');
        document.getElementById('btn-logout').classList.add('hidden');
        renderChild();
    }

    function exitPreview() {
        isPreviewMode = false;
        document.getElementById('screen-child').classList.add('hidden');
        document.getElementById('screen-admin').classList.remove('hidden');
        document.getElementById('banner-preview').classList.add('hidden');
        document.getElementById('btn-logout').classList.remove('hidden');
    }

    // --- Child ---
    function renderChild() {
        const kid = db.children[activeKidIdx];
        const hr = new Date().getHours();
        const sess = hr < 15 ? 'am' : 'pm';
        const today = new Date().toLocaleDateString();

        document.getElementById('child-title').innerText = `×”×™×™ ${kid.name}! ğŸ‘‹`;
        document.getElementById('child-score').innerText = kid.points;
        
        const available = db.tasks.filter(t => {
            const isDone = kid.done && kid.done.some(d => d.id === t.id && d.d === today && d.s === sess);
            const isPending = db.pending.some(p => p.childName === kid.name && p.taskId === t.id && p.sess === sess);
            if (isDone || isPending) return false;
            if (t.type === 'morning') return hr < 15;
            if (t.type === 'evening') return hr >= 12;
            return true;
        });

        document.getElementById('child-tasks-list').innerHTML = available.map(t => `
            <div class="item-row" onclick="reqTask(${t.id}, '${t.name}', ${t.points})">
                <div class="item-icon">${t.emoji}</div>
                <div class="item-info"><b>${t.name}</b></div>
                <div class="pts-tag">+${t.points} â­</div>
            </div>`).join('') || "<div style='text-align:center; padding:30px; color:#aaa;'>×¡×™×™××ª ×”×›×œ! ğŸ†</div>";
    }

    function reqTask(id, name, pts) {
        if(isPreviewMode) return alert("×‘××¦×‘ ×¦×¤×™×™×” ×œ× × ×™×ª×Ÿ ×œ×©×œ×•×— ×‘×§×©×•×ª ×××™×ª×™×•×ª.");
        const sess = new Date().getHours() < 15 ? 'am' : 'pm';
        db.pending.push({ taskId: id, taskName: name, childName: db.children[activeKidIdx].name, pts: pts, sess: sess });
        save(); renderChild(); alert("× ×©×œ×— ×œ××™×©×•×¨! âœ…");
    }

    function openStore() {
        document.getElementById('child-tasks-panel').classList.add('hidden');
        document.getElementById('child-store-panel').classList.remove('hidden');
        document.getElementById('child-rewards-list').innerHTML = db.rewards.map(r => `
            <div class="item-row" onclick="buyReward('${r.name}', ${r.points})">
                <div class="item-icon">${r.emoji}</div>
                <div class="item-info"><b>${r.name}</b></div>
                <div class="pts-tag" style="background:#fff9e6; color:#d4af37;">${r.points} â­</div>
            </div>`).join('');
    }

    function buyReward(name, cost) {
        if(isPreviewMode) return alert("×‘××¦×‘ ×¦×¤×™×™×” ×œ× × ×™×ª×Ÿ ×œ×‘×¦×¢ ×§× ×™×™×”.");
        const kid = db.children[activeKidIdx];
        if (kid.points < cost) return alert("×—×¡×¨×™× ×œ×š ×›×•×›×‘×™×!");
        if (confirm(`×œ×§× ×•×ª ${name}?`)) { kid.points -= cost; save(); closeStore(); renderChild(); }
    }

    function closeStore() {
        document.getElementById('child-tasks-panel').classList.remove('hidden');
        document.getElementById('child-store-panel').classList.add('hidden');
    }

    // --- Lobby ---
    function enterAdmin() { if (prompt("×¡×™×¡××”:") === "1234") { document.getElementById('screen-lobby').classList.add('hidden'); document.getElementById('screen-admin').classList.remove('hidden'); setAdminTab('approve'); } }
    
    function kidLogin(idx) {
        if (prompt(`×§×•×“ ×¢×‘×•×¨ ${db.children[idx].name}:`) === db.children[idx].pin) {
            activeKidIdx = idx;
            document.getElementById('screen-lobby').classList.add('hidden');
            document.getElementById('screen-child').classList.remove('hidden');
            renderChild();
        }
    }

    function renderLobby() {
        document.getElementById('lobby-kids').innerHTML = db.children.map((c, i) => `<div onclick="kidLogin(${i})" style="text-align:center; cursor:pointer;"><div class="avatar-circle">ğŸ‘¤</div><b>${c.name}</b><br><span style="color:var(--p); font-size:0.8rem; font-weight:bold;">${c.points} â­</span></div>`).join('');
        const prc = Math.min((db.goal.current / db.goal.target) * 100, 100);
        document.getElementById('lobby-goal-bar').style.width = prc + "%";
        document.getElementById('lobby-goal-name').innerText = `×”×™×¢×“ ×”××©×¤×—×ª×™: ${db.goal.name}`;
        document.getElementById('lobby-goal-stats').innerText = `${db.goal.current} / ${db.goal.target}`;
    }

    renderLobby();
</script>
</body>
</html>

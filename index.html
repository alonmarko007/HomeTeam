<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>××¨×§×•×‘×™×¥' v31.22 - Expert Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { --p: #4a90e2; --success: #2ed573; --danger: #ff4757; --gold: #f1c40f; --bg: #f8fbff; --card-border: #e1e8f0; }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); text-align: center; margin: 0; direction: rtl; user-select: none; color: #2d3436; }
        .app-container { background: white; max-width: 500px; margin: 0 auto; min-height: 100vh; display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.05); position: relative; }
        .hidden { display: none !important; }
        
        /* Header & Score */
        .header { padding: 20px; border-bottom: 1px solid #eee; }
        .score-display { background: white; border: 4px solid var(--p); border-radius: 50px; display: inline-block; padding: 15px 40px; margin: 15px 0; box-shadow: 0 8px 20px rgba(74,144,226,0.2); }
        .score-num { font-size: 3rem; font-weight: 900; color: var(--p); line-height: 1; display: block; }
        
        /* Goal Progress */
        .goal-box { background: #fff9e6; margin: 15px; padding: 15px; border-radius: 20px; border: 2px solid #fcebb6; }
        .progress-container { background: #eee; border-radius: 20px; height: 25px; margin-top: 10px; overflow: hidden; position: relative; }
        .progress-bar { background: linear-gradient(90deg, #2ed573, #7bed9f); height: 100%; transition: width 1s cubic-bezier(0.17, 0.67, 0.83, 0.67); }
        .progress-text { position: absolute; width: 100%; top: 0; font-size: 0.85rem; font-weight: bold; line-height: 25px; }

        /* Items (Tasks/Rewards) */
        .list-container { padding: 10px 15px; flex-grow: 1; }
        .item-card { background: white; border: 1px solid var(--card-border); border-radius: 18px; padding: 12px; margin-bottom: 10px; display: flex; align-items: center; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .item-card:active { transform: scale(0.98); background: #f9f9f9; }
        .icon-circle { width: 50px; height: 50px; background: #f0f7ff; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; margin-left: 12px; }
        .item-info { flex-grow: 1; text-align: right; }
        .item-title { font-weight: 800; font-size: 1.1rem; display: block; }
        .points-badge { background: #fff4e5; color: #e67e22; padding: 5px 12px; border-radius: 10px; font-weight: 800; font-size: 0.9rem; }

        /* Navigation */
        .admin-tabs { display: flex; background: #f1f2f6; margin: 10px; border-radius: 12px; padding: 4px; }
        .tab-btn { flex: 1; border: none; padding: 10px; border-radius: 8px; font-weight: bold; background: none; cursor: pointer; }
        .tab-btn.active { background: white; color: var(--p); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* UI Elements */
        .btn-main { background: var(--p); color: white; border: none; padding: 15px; border-radius: 15px; font-weight: bold; width: 100%; cursor: pointer; font-size: 1rem; }
        .btn-gold { background: var(--gold); color: white; border: none; padding: 15px; border-radius: 15px; font-weight: bold; width: 100%; cursor: pointer; }
        input, select { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #ddd; border-radius: 10px; font-size: 1rem; box-sizing: border-box; }
        
        .footer-version { font-size: 0.7rem; color: #ccc; padding: 15px; font-weight: bold; }
    </style>
</head>
<body>

<div class="app-container">
    <div id="view-home">
        <h1 style="margin-top:20px;">××¨×§×•×‘×™×¥' âœ¨</h1>
        <div class="goal-box">
            <div id="goal-label" style="font-weight:bold;">×”×™×¢×“ ×©×œ× ×•</div>
            <div class="progress-container">
                <div id="goal-bar" class="progress-bar" style="width: 0%"></div>
                <div id="goal-text" class="progress-text">0 / 0</div>
            </div>
        </div>
        <div id="children-grid" style="display:flex; justify-content:center; gap:20px; padding:20px;"></div>
        <button onclick="showAdmin()" style="background:none; border:none; color:#aaa; cursor:pointer;">âš™ï¸ ×”×’×“×¨×•×ª ×”×•×¨×™×</button>
        <div class="footer-version">v31.22 | PRODUCTION READY</div>
    </div>

    <div id="view-admin" class="hidden">
        <div class="admin-tabs">
            <button class="tab-btn active" onclick="switchTab('approve', this)">××™×©×•×¨×™×</button>
            <button class="tab-btn" onclick="switchTab('tasks', this)">××©×™××•×ª</button>
            <button class="tab-btn" onclick="switchTab('rewards', this)">×¤×¨×¡×™×</button>
        </div>
        <div class="list-container">
            <div id="admin-content"></div>
        </div>
        <div id="admin-editor" class="hidden" style="padding:15px; background:#f9f9f9; border-top:1px solid #eee;">
            <div id="editor-fields"></div>
            <button id="editor-save-btn" class="btn-main" style="margin-top:10px;">×©××•×¨</button>
        </div>
        <button onclick="location.reload()" style="margin:15px; padding:10px; background:#333; color:white; border-radius:10px;">ğŸ  ×—×–×¨×”</button>
    </div>

    <div id="view-child" class="hidden">
        <div class="header">
            <h2 id="child-welcome"></h2>
            <div class="score-display">
                <span id="child-points" class="score-num">0</span>
                <span style="font-weight:bold; color:#666;">×›×•×›×‘×™× ×©×œ×™</span>
            </div>
        </div>
        
        <div id="child-tasks-view" class="list-container">
            <div id="tasks-list"></div>
            <button onclick="toggleStore(true)" class="btn-gold" style="margin-top:20px;">ğŸ ×—× ×•×ª ×¤×¨×¡×™×</button>
        </div>

        <div id="child-store-view" class="list-container hidden">
            <h3 style="color:var(--gold)">×—× ×•×ª ×”××ª× ×•×ª</h3>
            <div id="store-list"></div>
            <button onclick="toggleStore(false)" style="margin-top:20px; background:#eee; border:none; padding:10px; border-radius:10px; width:100%;">×—×–×¨×” ×œ××©×™××•×ª</button>
        </div>
        
        <button onclick="location.reload()" style="margin:20px; background:none; border:none; color:#ccc;">ğŸ  ×”×—×œ×£ ××©×ª××©</button>
    </div>
</div>

<script>
    const STORAGE_KEY = 'MARKOVICH_FINAL_DB';
    const INITIAL_DATA = {
        children: [{name:"×¨× ×™", pin:"1234", points:0, doneToday:[]}, {name:"××•×¤×™×¨", pin:"1234", points:0, doneToday:[]}, {name:"××•×¨×™", pin:"1234", points:0, doneToday:[]}],
        tasks: [{id:1, name:"×¦×—×¦×•×— ×©×™× ×™×™×", points:2, type:"both", emoji:"ğŸ¦·"}, {id:2, name:"×œ×”×ª×œ×‘×©", points:2, type:"morning", emoji:"ğŸ‘•"}],
        rewards: [{id:1, name:"×××ª×§", points:5, emoji:"ğŸ¬"}],
        pending: [],
        goal: { name: "×¤×™×¦×”", target: 50, current: 0 }
    };

    let db = JSON.parse(localStorage.getItem(STORAGE_KEY)) || INITIAL_DATA;
    let activeChildIdx = null;
    let currentTab = 'approve';

    function save() { 
        localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); 
        renderHome();
    }

    // --- Admin Logic ---
    function switchTab(tab, btn) {
        currentTab = tab;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('admin-editor').classList.add('hidden');
        renderAdmin();
    }

    function renderAdmin() {
        const container = document.getElementById('admin-content');
        if (currentTab === 'approve') {
            container.innerHTML = db.pending.map((p, i) => `
                <div class="item-card">
                    <div class="item-info"><b>${p.childName}</b><br>${p.taskName}</div>
                    <button onclick="approveTask(${i})" style="background:var(--success); color:white; border-radius:8px; padding:10px;">âœ… ××©×¨</button>
                </div>`).join('') || "××™×Ÿ ×‘×§×©×•×ª ×××ª×™× ×•×ª";
        } else if (currentTab === 'tasks') {
            container.innerHTML = db.tasks.map((t, i) => `
                <div class="item-card">
                    <div class="icon-circle">${t.emoji}</div>
                    <div class="item-info">${t.name} (${t.points}â­)</div>
                    <button onclick="editTask(${i})">ğŸ“</button>
                </div>`).join('') + `<button class="btn-main" style="margin-top:10px;" onclick="editTask(-1)">+ ××©×™××” ×—×“×©×”</button>`;
        } else if (currentTab === 'rewards') {
            container.innerHTML = db.rewards.map((r, i) => `
                <div class="item-card">
                    <div class="icon-circle">${r.emoji || 'ğŸ'}</div>
                    <div class="item-info">${r.name} (${r.points}â­)</div>
                    <button onclick="db.rewards.splice(${i},1);save();renderAdmin();">ğŸ—‘ï¸</button>
                </div>`).join('') + `<button class="btn-gold" style="margin-top:10px;" onclick="addRewardPrompt()">+ ×¤×¨×¡ ×—×“×©</button>`;
        }
    }

    function editTask(idx) {
        const editor = document.getElementById('admin-editor');
        const fields = document.getElementById('editor-fields');
        const isNew = idx === -1;
        const task = isNew ? {name:'', points:2, emoji:'âœ¨', type:'both'} : db.tasks[idx];
        
        editor.classList.remove('hidden');
        fields.innerHTML = `
            <input type="text" id="ed-name" value="${task.name}" placeholder="×©× ×”××©×™××”">
            <input type="number" id="ed-pts" value="${task.points}" placeholder="× ×™×§×•×“">
            <select id="ed-type">
                <option value="both" ${task.type==='both'?'selected':''}>×ª××™×“</option>
                <option value="morning" ${task.type==='morning'?'selected':''}>×‘×•×§×¨</option>
                <option value="evening" ${task.type==='evening'?'selected':''}>×¢×¨×‘</option>
            </select>
            <input type="text" id="ed-emoji" value="${task.emoji}" placeholder="××™××•×’'×™">
        `;
        
        document.getElementById('editor-save-btn').onclick = () => {
            const updated = {
                id: isNew ? Date.now() : task.id,
                name: document.getElementById('ed-name').value,
                points: parseInt(document.getElementById('ed-pts').value) || 0,
                type: document.getElementById('ed-type').value,
                emoji: document.getElementById('ed-emoji').value
            };
            if(isNew) db.tasks.push(updated); else db.tasks[idx] = updated;
            save(); renderAdmin();
            editor.classList.add('hidden');
        };
    }

    function approveTask(i) {
        const p = db.pending[i];
        const child = db.children.find(c => c.name === p.childName);
        if(child) {
            child.points += p.points;
            db.goal.current += p.points;
            if(!child.doneToday) child.doneToday = [];
            child.doneToday.push({id: p.taskId, date: new Date().toLocaleDateString(), sess: p.sess});
        }
        db.pending.splice(i, 1);
        confetti();
        save();
        renderAdmin();
    }

    function addRewardPrompt() {
        const n = prompt("×©× ×”×¤×¨×¡:");
        const p = parseInt(prompt("×›××” ×›×•×›×‘×™×?"));
        if(n && p) { db.rewards.push({id:Date.now(), name:n, points:p, emoji:"ğŸ"}); save(); renderAdmin(); }
    }

    // --- Child Logic ---
    function updateChildUI() {
        const c = db.children[activeChildIdx];
        const hr = new Date().getHours();
        const sess = hr < 15 ? 'am' : 'pm';
        const today = new Date().toLocaleDateString();

        document.getElementById('child-welcome').innerText = `×”×™×™ ${c.name}!`;
        document.getElementById('child-points').innerText = c.points;

        const availableTasks = db.tasks.filter(t => {
            const pending = db.pending.some(p => p.childName === c.name && p.taskId === t.id && p.sess === sess);
            const done = c.doneToday && c.doneToday.some(d => d.id === t.id && d.date === today && d.sess === sess);
            if(pending || done) return false;
            if(t.type === 'morning') return hr < 15;
            if(t.type === 'evening') return hr >= 12;
            return true;
        });

        document.getElementById('tasks-list').innerHTML = availableTasks.map(t => `
            <div class="item-card" onclick="requestTask(${t.id}, '${t.name}', ${t.points})">
                <div class="icon-circle">${t.emoji}</div>
                <div class="item-info"><span class="item-title">${t.name}</span></div>
                <div class="points-badge">+${t.points} â­</div>
            </div>`).join('') || "×¡×™×™××ª ×”×›×œ! ğŸ†";
    }

    function requestTask(id, name, pts) {
        const sess = new Date().getHours() < 15 ? 'am' : 'pm';
        db.pending.push({ taskId: id, taskName: name, childName: db.children[activeChildIdx].name, points: pts, sess: sess });
        save(); updateChildUI();
        alert("× ×©×œ×— ×œ××™×©×•×¨ ×”×•×¨×™×! âœ…");
    }

    function toggleStore(show) {
        document.getElementById('child-tasks-view').classList.toggle('hidden', show);
        document.getElementById('child-store-view').classList.toggle('hidden', !show);
        if(show) {
            document.getElementById('store-list').innerHTML = db.rewards.map(r => `
                <div class="item-card" onclick="buyReward('${r.name}', ${r.points})">
                    <div class="icon-circle">${r.emoji || 'ğŸ'}</div>
                    <div class="item-info"><span class="item-title">${r.name}</span></div>
                    <div class="points-badge" style="background:#fff9e6; color:#d4af37;">${r.points} â­</div>
                </div>`).join('');
        }
    }

    function buyReward(name, cost) {
        const c = db.children[activeChildIdx];
        if(c.points < cost) return alert("×—×¡×¨×™× ×œ×š ×›×•×›×‘×™×! ×ª××©×™×š ×‘××©×™××•×ª ğŸ’ª");
        if(confirm(`×œ×§× ×•×ª ${name}?`)) {
            c.points -= cost;
            save(); updateChildUI(); toggleStore(false);
            alert("×ª×ª×—×“×©! ×”×¤×¨×¡ ××—×›×” ×œ×š ××”×”×•×¨×™× ğŸ");
        }
    }

    // --- Global ---
    function showAdmin() { if(prompt("×¡×™×¡××”:") === "1234") { 
        document.getElementById('view-home').classList.add('hidden');
        document.getElementById('view-admin').classList.remove('hidden');
        renderAdmin();
    } }

    function login(idx) {
        if(prompt("×¡×™×¡××” (×‘×¨×™×¨×ª ××—×“×œ 1234):") === db.children[idx].pin) {
            activeChildIdx = idx;
            document.getElementById('view-home').classList.add('hidden');
            document.getElementById('view-child').classList.remove('hidden');
            updateChildUI();
        }
    }

    function renderHome() {
        document.getElementById('children-grid').innerHTML = db.children.map((c, i) => `
            <div onclick="login(${i})" style="cursor:pointer">
                <div style="width:80px; height:80px; border-radius:50%; background:#f0f7ff; border:3px solid var(--p); display:flex; align-items:center; justify-content:center; font-size:2rem;">ğŸ‘¤</div>
                <div style="font-weight:bold; margin-top:5px;">${c.name}</div>
            </div>`).join('');
        
        const goalPrc = Math.min((db.goal.current / db.goal.target) * 100, 100);
        document.getElementById('goal-bar').style.width = goalPrc + "%";
        document.getElementById('goal-text').innerText = `${db.goal.current} / ${db.goal.target}`;
        document.getElementById('goal-label').innerText = `×”×™×¢×“ ×œ××©×¤×—×”: ${db.goal.name}`;
    }

    renderHome();
</script>
</body>
</html>

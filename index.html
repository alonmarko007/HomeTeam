<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>××¨×§×•×‘×™×¥' v26.9 - ××™×©×•×¨ ×”×•×¨×™× âœ…</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root { --p: #4a90e2; --s: #ffeb3b; --morning: #ff9f43; --evening: #a29bfe; --danger: #ff4757; --success: #2ed573; --bg: #f0f7ff; --pending: #ffa502; }
        body { font-family: system-ui, sans-serif; background: var(--bg); text-align: center; margin: 0; direction: rtl; user-select: none; }
        .card { background: white; padding: 15px; border-radius: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); max-width: 500px; margin: auto; min-height: 95vh; display: flex; flex-direction: column; box-sizing: border-box; }
        .hidden { display: none !important; }
        
        /* ×¢×™×¦×•×‘ ××©×™××•×ª */
        .item-row { background: white; border: 2px solid #eee; padding: 12px; border-radius: 18px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; transition: 0.3s; }
        .status-pending { border-color: var(--pending); background: #fffaf0; }
        .status-pending::after { content: "â³ ×××ª×™×Ÿ ×œ××™×©×•×¨"; font-size: 0.7rem; color: var(--pending); font-weight: bold; }
        .done { opacity: 0.5; background: #f1f2f6; pointer-events: none; }

        /* ×‘×•×¢×ª ×”×ª×¨××•×ª ×œ×”×•×¨×™× */
        .admin-badge { background: var(--danger); color: white; border-radius: 50%; padding: 2px 8px; font-size: 0.8rem; margin-right: 5px; }
        
        button { border-radius: 12px; border: none; padding: 12px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button:active { transform: scale(0.98); }
        .btn-approve { background: var(--success); color: white; padding: 5px 10px; width: auto; }
        .btn-reject { background: var(--danger); color: white; padding: 5px 10px; width: auto; margin-right: 5px; }
        
        #loading-bar { position: fixed; top: 0; left: 0; height: 3px; background: var(--p); transition: width 0.3s; width: 0%; z-index: 2000; }
        .avatar-main { width: 80px; height: 80px; border-radius: 50%; border: 3px solid var(--p); object-fit: cover; }
    </style>
</head>
<body>

<div id="loading-bar"></div>

<div class="card">
    <div id="login-screen">
        <h2 style="margin-top: 20px;">××©×¤×—×ª ××¨×§×•×‘×™×¥' âœ¨</h2>
        <div id="children-list" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px;"></div>
        <button onclick="showAdmin()" style="background:#636e72; color: white; width: 80%;">âš™ï¸ ×”×’×“×¨×•×ª ×”×•×¨×™× <span id="pending-badge-login" class="admin-badge hidden">0</span></button>
    </div>

    <div id="main-screen" class="hidden">
        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <button onclick="location.reload()" style="background:none; color:#636e72; padding:0;">ğŸ”™ ×™×¦×™××”</button>
            <div id="user-info" style="text-align: left;">
                <b id="user-title"></b>
                <div id="points-display" style="color: var(--p); font-size: 1.2rem; font-weight: bold;">â­ 0</div>
            </div>
            <div id="avatar-box"></div>
        </div>
        
        <div id="greeting-display" style="font-size: 0.9rem; margin-bottom: 15px; color: #666;"></div>

        <div id="tasks-list"></div>
        
        <button onclick="showShop()" style="background:var(--success); color: white; margin-top: 15px; width: 100%; font-size: 1.1rem; height: 50px;">ğŸ ×—× ×•×ª ×”×¦'×•×¤×¨×™×</button>
    </div>

    <div id="admin-screen" class="hidden">
        <h3>× ×™×”×•×œ ×”×•×¨×™× ğŸ›¡ï¸</h3>
        
        <div class="admin-section" style="background: #fff3e0; border: 2px solid #ffb74d;">
            <h4 style="margin: 5px 0;">ğŸ”” ××©×™××•×ª ×”×××ª×™× ×•×ª ×œ××™×©×•×¨</h4>
            <div id="pending-tasks-list" style="max-height: 200px; overflow-y: auto;"></div>
        </div>

        <div class="admin-section">
            <h4>ğŸ“Š ××¦×‘ ×›×•×›×‘×™× × ×•×›×—×™</h4>
            <div id="mgmt-kids-list"></div>
        </div>

        <button onclick="forceSync()" style="background:var(--p); color:white; width: 100%; margin-top: 10px;">ğŸ”„ ×¡× ×›×¨×Ÿ × ×ª×•× ×™× ×¢×›×©×™×•</button>
        <button onclick="location.reload()" style="background:#333; color:white; width: 100%; margin-top: 10px;">ğŸ”™ ×—×–×¨×” ×œ×ª×¤×¨×™×˜</button>
    </div>
</div>

<script>
    const CLOUD_URL = "https://script.google.com/macros/s/AKfycbwz-PZrXzwzO-O0aHlOUZhIz0ShsM42Sm-jhwFMpa62uodDYhXDFuJIsqemCBblV5M/exec";
    let db = { children: [], tasks: [], history: [], pending: [], gifts: [] };
    let curIdx = null;

    async function init() {
        updateLoading(30);
        try {
            const r = await fetch(`${CLOUD_URL}?t=${Date.now()}`);
            db = await r.json();
            if (!db.pending) db.pending = [];
            render();
            updateLoading(100);
        } catch (e) { console.error(e); updateLoading(0); }
    }

    function render() {
        // ×¨×©×™××ª ×™×œ×“×™× ×‘×›× ×™×¡×”
        document.getElementById('children-list').innerHTML = db.children.map((c, i) => `
            <div onclick="login(${i})" style="cursor:pointer; background:white; border-radius:20px; padding:10px; border:2px solid #eee;">
                <img src="${c.img || 'https://via.placeholder.com/80'}" class="avatar-main"><br>
                <b>${c.name}</b>
            </div>
        `).join('');

        // ×”×ª×¨××•×ª ×œ×”×•×¨×™×
        const pCount = db.pending.length;
        const badge = document.getElementById('pending-badge-login');
        if (pCount > 0) { badge.innerText = pCount; badge.classList.remove('hidden'); }
        
        // ×¨×©×™××ª ××©×™××•×ª ×œ××™×©×•×¨ (×‘×××©×§ ×”×•×¨×™×)
        document.getElementById('pending-tasks-list').innerHTML = db.pending.length ? db.pending.map((p, i) => `
            <div class="item-row">
                <div style="text-align:right;">
                    <b>${p.childName}</b><br>
                    <small>${p.taskName} (${p.pts}â­)</small>
                </div>
                <div>
                    <button class="btn-approve" onclick="approveTask(${i})">âœ…</button>
                    <button class="btn-reject" onclick="rejectTask(${i})">âŒ</button>
                </div>
            </div>
        `).join('') : "<p>××™×Ÿ ××©×™××•×ª ×××ª×™× ×•×ª</p>";
    }

    async function login(i) {
        let p = prompt(`×¡×™×¡××” ×¢×‘×•×¨ ${db.children[i].name}:`);
        if (p !== db.children[i].pin) return alert("×¡×™×¡××” ×©×’×•×™×”");
        
        curIdx = i;
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('main-screen').classList.remove('hidden');
        
        updateChildUI();
    }

    function updateChildUI() {
        const child = db.children[curIdx];
        document.getElementById('user-title').innerText = child.name;
        document.getElementById('points-display').innerText = `â­ ${child.points}`;
        document.getElementById('avatar-box').innerHTML = `<img src="${child.img || ''}" class="avatar-main">`;
        
        const hour = new Date().getHours();
        const type = (hour >= 5 && hour < 15) ? 'morning' : 'evening';
        
        document.getElementById('tasks-list').innerHTML = db.tasks
            .filter(t => t.type === type && (t.target === 'all' || t.target === child.name))
            .map(t => {
                const isPending = db.pending.some(p => p.childName === child.name && p.taskId === t.id);
                const isDone = child.doneToday && child.doneToday.includes(t.id);
                
                return `
                    <div class="item-row ${isDone ? 'done' : ''} ${isPending ? 'status-pending' : ''}" 
                         onclick="${(!isDone && !isPending) ? `submitForApproval(${t.id}, '${t.name}', ${t.points})` : ''}">
                        <span>${t.name}</span>
                        <b>${t.points}â­</b>
                    </div>
                `;
            }).join('');
    }

    async function submitForApproval(id, name, pts) {
        // ×¢×“×›×•×Ÿ ××•×¤×˜×™××™ - ××¨××” ×œ×™×œ×“ ×©×–×” × ×©×œ×— ××™×“
        db.pending.push({
            taskId: id,
            taskName: name,
            childName: db.children[curIdx].name,
            pts: pts,
            time: new Date().toLocaleTimeString('he-IL', {hour:'2-digit', minute:'2-digit'})
        });
        
        updateChildUI(); // ×¨×¢× ×•×Ÿ ×”××¡×š ×©×œ ×”×™×œ×“
        await quickSave();
    }

    async function approveTask(i) {
        const p = db.pending[i];
        const child = db.children.find(c => c.name === p.childName);
        if (child) {
            child.points += p.pts;
            if (!child.doneToday) child.doneToday = [];
            child.doneToday.push(p.taskId);
            
            db.history.push({
                child: child.name,
                task: p.taskName,
                pts: p.pts,
                time: p.time
            });
        }
        db.pending.splice(i, 1);
        render();
        await quickSave();
    }

    async function rejectTask(i) {
        db.pending.splice(i, 1);
        render();
        await quickSave();
    }

    async function quickSave() {
        updateLoading(50);
        await fetch(CLOUD_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(db) });
        updateLoading(100);
        setTimeout(() => updateLoading(0), 1000);
    }

    function showAdmin() {
        if (prompt("×¡×™×¡××ª ×”×•×¨×”:") === "1234") {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('admin-screen').classList.remove('hidden');
            render();
        }
    }

    function updateLoading(p) { document.getElementById('loading-bar').style.width = p + "%"; }
    function toggleBox(id) { document.getElementById(id).classList.toggle('hidden'); }
    async function forceSync() { await init(); }

    init();
</script>
</body>
</html>

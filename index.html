<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>××¨×§×•×‘×™×¥' v31.26 - ×”×¦'×•×¤×¨×™× ×›××Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { --p: #4a90e2; --success: #2ed573; --danger: #ff4757; --gold: #f1c40f; --bg: #f4f7f6; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); margin: 0; direction: rtl; user-select: none; color: #333; }
        .app { max-width: 500px; margin: 0 auto; min-height: 100vh; background: white; display: flex; flex-direction: column; box-shadow: 0 0 30px rgba(0,0,0,0.1); position: relative; }
        .hidden { display: none !important; }
        
        /* Goal UI */
        .goal-card { background: #fff9e6; margin: 20px; padding: 20px; border-radius: 25px; border: 2px solid #fcebb6; text-align: right; }
        .progress-container { background: #eee; height: 20px; border-radius: 10px; margin: 12px 0; overflow: hidden; position: relative; }
        .progress-fill { background: linear-gradient(90deg, #2ed573, #7bed9f); height: 100%; width: 0%; transition: width 1s ease; }
        .progress-text { position: absolute; width: 100%; text-align: center; font-size: 0.8rem; font-weight: bold; line-height: 20px; top: 0; color: #444; }

        /* Rows */
        .item-row { background: white; border: 1px solid #eee; border-radius: 20px; padding: 15px; margin-bottom: 12px; display: flex; align-items: center; cursor: pointer; }
        .item-icon { width: 50px; height: 50px; background: #f0f7ff; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; margin-left: 15px; }
        .item-info { flex-grow: 1; text-align: right; }
        .pts-tag { background: #fff4e5; color: #e67e22; padding: 5px 12px; border-radius: 12px; font-weight: 800; font-size: 0.9rem; }

        /* Admin Tabs */
        .admin-nav { display: flex; background: #f1f2f6; margin: 10px; border-radius: 15px; padding: 5px; }
        .nav-tab { flex: 1; border: none; padding: 10px; border-radius: 10px; font-weight: bold; background: none; cursor: pointer; font-size: 0.85rem; }
        .nav-tab.active { background: white; color: var(--p); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

        .btn-gold { background: var(--gold); color: white; border: none; padding: 18px; border-radius: 20px; font-weight: 800; width: 100%; font-size: 1.2rem; cursor: pointer; }
        .avatar-circle { width: 75px; height: 75px; border-radius: 50%; border: 3px solid var(--p); display: flex; align-items: center; justify-content: center; font-size: 2rem; background: white; margin: 0 auto 10px; }
        .version { font-size: 0.7rem; color: #ccc; text-align: center; padding: 15px; font-weight: bold; margin-top: auto; }
    </style>
</head>
<body>

<div class="app">
    <div id="screen-lobby">
        <h1 style="text-align:center; margin-top:30px;">××¨×§×•×‘×™×¥' âœ¨</h1>
        <div class="goal-card">
            <div id="lobby-goal-name" style="font-weight:bold; color:#d35400; font-size:1.1rem;">×”×™×¢×“ ×”××©×¤×—×ª×™: ×˜×•×¢×Ÿ...</div>
            <div class="progress-container">
                <div id="lobby-goal-bar" class="progress-fill"></div>
                <div id="lobby-goal-stats" class="progress-text">0 / 0</div>
            </div>
        </div>
        <div id="lobby-kids" style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:15px; padding:20px;"></div>
        <button onclick="enterAdmin()" style="background:none; border:none; color:#ccc; width:100%; font-weight:bold; cursor:pointer;">âš™ï¸ × ×™×”×•×œ ×”×•×¨×™×</button>
        <div class="version">×’×™×¨×¡×” v31.26 | DB: LocalStorage</div>
    </div>

    <div id="screen-child" class="hidden">
        <div style="padding:30px 20px; text-align:center;">
            <h2 id="child-hi" style="margin:0;">×”×™×™! ğŸ‘‹</h2>
            <span id="child-pts" style="font-size:4rem; font-weight:900; color:var(--p); display:block;">0</span>
            <span style="font-weight:bold; color:#666;">×›×•×›×‘×™× ×©×¦×‘×¨×ª</span>
        </div>
        
        <div id="panel-tasks" style="padding:0 20px;">
            <div id="list-tasks"></div>
            <button onclick="showStore(true)" class="btn-gold" style="margin-top:20px; box-shadow: 0 5px 15px rgba(241,196,15,0.4);">ğŸ ×—× ×•×ª ×”×¦'×•×¤×¨×™×</button>
        </div>

        <div id="panel-store" class="hidden" style="padding:0 20px;">
            <h2 style="text-align:center; color:var(--gold); margin-bottom:20px;">×—× ×•×ª ×”×¦'×•×¤×¨×™× ğŸ›ï¸</h2>
            <div id="list-rewards"></div>
            <button onclick="showStore(false)" style="width:100%; background:#eee; border:none; padding:15px; border-radius:15px; margin-top:10px; font-weight:bold;">ğŸ”™ ×—×–×¨×” ×œ××©×™××•×ª</button>
        </div>
        
        <button onclick="location.reload()" style="margin:40px auto; display:block; background:none; border:none; color:#bbb;">ğŸ  ×”×—×œ×£ ××©×ª××©</button>
    </div>

    <div id="screen-admin" class="hidden">
        <div class="admin-nav">
            <button id="t-approve" class="nav-tab active" onclick="setTab('approve')">××™×©×•×¨×™×</button>
            <button id="t-tasks" class="nav-tab" onclick="setTab('tasks')">××©×™××•×ª</button>
            <button id="t-rewards" class="nav-tab" onclick="setTab('rewards')">×¦'×•×¤×¨×™×</button>
            <button id="t-config" class="nav-tab" onclick="setTab('config')">×”×’×“×¨×•×ª</button>
        </div>
        <div id="admin-body" style="padding:20px; flex-grow:1; overflow-y:auto;"></div>
        <button onclick="location.reload()" style="margin:20px; background:#333; color:white; border:none; padding:12px; border-radius:12px;">ğŸ  ×—×–×¨×” ×œ×‘×™×ª</button>
    </div>
</div>

<script>
    const KEY = 'MARKOVICH_FINAL_DB';
    const INIT = {
        children: [{id:1, name:"×¨× ×™", pin:"1234", points:0, done:[]}, {id:2, name:"××•×¤×™×¨", pin:"1234", points:0, done:[]}, {id:3, name:"××•×¨×™", pin:"1234", points:0, done:[]}],
        tasks: [{id:101, name:"×¦×—×¦×•×— ×©×™× ×™×™×", points:2, type:"both", emoji:"ğŸ¦·"}, {id:102, name:"×œ×”×ª×œ×‘×© ×œ×‘×“", points:2, type:"morning", emoji:"ğŸ‘•"}],
        rewards: [{id:201, name:"×–××Ÿ ××¡×š (15 ×“×§')", points:10, emoji:"ğŸ“±"}, {id:202, name:"×××ª×§ ×œ×‘×—×™×¨×”", points:5, emoji:"ğŸ­"}],
        pending: [], goal: { name: "×¢×¨×‘ ×¤×™×¦×”", target: 100, current: 0 }
    };

    let db = JSON.parse(localStorage.getItem(KEY)) || INIT;
    db = {...INIT, ...db}; 

    let curChildIdx = -1;
    let curTab = 'approve';

    function save() { localStorage.setItem(KEY, JSON.stringify(db)); renderLobby(); }

    // --- Admin ---
    function setTab(t) {
        curTab = t;
        document.querySelectorAll('.nav-tab').forEach(b => b.classList.toggle('active', b.id.includes(t)));
        renderAdmin();
    }

    function renderAdmin() {
        const body = document.getElementById('admin-body');
        if (curTab === 'approve') {
            body.innerHTML = db.pending.map((p, i) => `
                <div class="item-row" style="justify-content:space-between">
                    <div style="text-align:right"><b>${p.childName}</b><br>${p.taskName} (+${p.pts}â­)</div>
                    <button onclick="doApprove(${i})" style="background:var(--success); color:white; border:none; padding:10px; border-radius:10px;">âœ… ××©×¨</button>
                </div>`).join('') || "××™×Ÿ ×‘×§×©×•×ª ×—×“×©×•×ª";
        } else if (curTab === 'rewards') {
            body.innerHTML = `<h3>× ×™×”×•×œ ×—× ×•×ª (×¦'×•×¤×¨×™×)</h3>` + db.rewards.map((r, i) => `
                <div class="item-row">
                    <div style="flex-grow:1; text-align:right;">${r.emoji} ${r.name} (${r.points}â­)</div>
                    <button onclick="db.rewards.splice(${i},1);save();renderAdmin();" style="border:none; background:none; color:red;">ğŸ—‘ï¸</button>
                </div>`).join('') + `<button onclick="addR()" class="btn-gold" style="font-size:0.9rem; padding:10px; margin-top:10px;">+ ×”×•×¡×£ ×¦'×•×¤×¨ ×—×“×©</button>`;
        } else if (curTab === 'tasks') {
            body.innerHTML = `<h3>× ×™×”×•×œ ××©×™××•×ª</h3>` + db.tasks.map((t, i) => `
                <div class="item-row"><div style="flex-grow:1; text-align:right;">${t.emoji} ${t.name} (${t.points}â­)</div><button onclick="db.tasks.splice(${i},1);save();renderAdmin();" style="border:none; background:none; color:red;">ğŸ—‘ï¸</button></div>`).join('') + `<button onclick="addT()" class="btn-gold" style="font-size:0.9rem; padding:10px; margin-top:10px;">+ ×”×•×¡×£ ××©×™××” ×—×“×©×”</button>`;
        } else if (curTab === 'config') {
            body.innerHTML = `<h3>×”×’×“×¨×ª ×™×¢×“</h3><input id="gn" value="${db.goal.name}" style="width:100%; padding:10px;"><input id="gt" type="number" value="${db.goal.target}" style="width:100%; margin-top:10px; padding:10px;"><button onclick="db.goal.name=document.getElementById('gn').value;db.goal.target=parseInt(document.getElementById('gt').value);save();alert('×¢×•×“×›×Ÿ');" class="btn-gold" style="padding:10px; margin-top:10px;">×©××•×¨ ×™×¢×“</button>`;
        }
    }

    function doApprove(i) {
        const p = db.pending[i];
        const k = db.children.find(c => c.name === p.childName);
        if(k) { k.points += p.pts; db.goal.current += p.pts; if(!k.done) k.done = []; k.done.push({id: p.taskId, d: new Date().toLocaleDateString(), s: p.sess}); }
        db.pending.splice(i,1); confetti(); save(); renderAdmin();
    }

    function addR() { const n = prompt("×©× ×”×¦'×•×¤×¨:"); const p = parseInt(prompt("×›××” ×›×•×›×‘×™×?")); if(n && p) { db.rewards.push({id:Date.now(), name:n, points:p, emoji:"ğŸ"}); save(); renderAdmin(); } }
    function addT() { const n = prompt("×©× ×”××©×™××”:"); const p = parseInt(prompt("×›××” ×›×•×›×‘×™×?")); if(n && p) { db.tasks.push({id:Date.now(), name:n, points:p, type:"both", emoji:"âœ¨"}); save(); renderAdmin(); } }

    // --- Child ---
    function renderChild() {
        const k = db.children[curChildIdx];
        const sess = new Date().getHours() < 15 ? 'am' : 'pm';
        const today = new Date().toLocaleDateString();
        document.getElementById('child-hi').innerText = `×”×™×™ ${k.name}! ğŸ‘‹`;
        document.getElementById('child-pts').innerText = k.points;
        
        const avail = db.tasks.filter(t => {
            const done = k.done && k.done.some(d => d.id === t.id && d.d === today && d.s === sess);
            const pend = db.pending.some(p => p.childName === k.name && p.taskId === t.id && p.sess === sess);
            return !done && !pend;
        });

        document.getElementById('list-tasks').innerHTML = avail.map(t => `
            <div class="item-row" onclick="reqT(${t.id},'${t.name}',${t.points})">
                <div class="item-icon">${t.emoji}</div>
                <div class="item-info"><b>${t.name}</b></div>
                <div class="pts-tag">+${t.points} â­</div>
            </div>`).join('') || "<div style='text-align:center; padding:20px;'>××™×Ÿ ××©×™××•×ª ×›×¨×’×¢ ğŸ†</div>";
    }

    function reqT(id, name, pts) {
        const sess = new Date().getHours() < 15 ? 'am' : 'pm';
        db.pending.push({ taskId: id, taskName: name, childName: db.children[curChildIdx].name, pts: pts, sess: sess });
        save(); renderChild(); alert("× ×©×œ×— ×œ××™×©×•×¨ ×”×•×¨×™×! âœ…");
    }

    function showStore(show) {
        document.getElementById('panel-tasks').classList.toggle('hidden', show);
        document.getElementById('panel-store').classList.toggle('hidden', !show);
        if(show) {
            document.getElementById('list-rewards').innerHTML = db.rewards.map(r => `
                <div class="item-row" onclick="buyR('${r.name}', ${r.points})">
                    <div class="item-icon">${r.emoji}</div>
                    <div class="item-info"><b>${r.name}</b></div>
                    <div class="pts-tag" style="background:#fff9e6; color:#d4af37;">${r.points} â­</div>
                </div>`).join('');
        }
    }

    function buyR(name, cost) {
        const k = db.children[curChildIdx];
        if(k.points < cost) return alert("×—×¡×¨×™× ×œ×š ×›×•×›×‘×™×! ×ª××©×™×š ×‘××©×™××•×ª ğŸ’ª");
        if(confirm(`×œ×§× ×•×ª ${name}?`)) { k.points -= cost; save(); showStore(false); renderChild(); alert("×ª×ª×—×“×©! ×”×¦'×•×¤×¨ ××—×›×” ×œ×š ××¦×œ ×”×”×•×¨×™× ğŸ"); }
    }

    // --- Global ---
    function enterAdmin() { if(prompt("×¡×™×¡××”:")==="1234") { document.getElementById('screen-lobby').classList.add('hidden'); document.getElementById('screen-admin').classList.remove('hidden'); setTab('approve'); } }
    function kidLogin(i) { if(prompt(`×§×•×“ ×¢×‘×•×¨ ${db.children[i].name}:`)===db.children[i].pin) { curChildIdx=i; document.getElementById('screen-lobby').classList.add('hidden'); document.getElementById('screen-child').classList.remove('hidden'); renderChild(); } }

    function renderLobby() {
        document.getElementById('lobby-kids').innerHTML = db.children.map((c, i) => `<div onclick="kidLogin(${i})" style="text-align:center; cursor:pointer;"><div class="avatar-circle">ğŸ‘¤</div><b>${c.name}</b><br><span style="color:var(--p); font-size:0.8rem; font-weight:bold;">${c.points} â­</span></div>`).join('');
        const prc = Math.min((db.goal.current / db.goal.target) * 100, 100);
        document.getElementById('lobby-goal-bar').style.width = prc + "%";
        document.getElementById('lobby-goal-name').innerText = `×”×™×¢×“ ×”××©×¤×—×ª×™: ${db.goal.name}`;
        document.getElementById('lobby-goal-stats').innerText = `${db.goal.current} / ${db.goal.target}`;
    }

    renderLobby();
</script>
</body>
</html>
